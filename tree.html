<html>

<head>
    <meta charset="utf-8">
    <script type="text/javascript" src="/_static/_common/scripts/jsTree.js"></script>
    <link rel="stylesheet" type="text/css" href="/_static/_common/styles/jsTree.css">
    <style type="text/css">
    p {
        margin: 0;
    }

    textarea,
    select,
    .inputs {
        border-radius: 5px;
    }

    label {
        color: white;
    }

    input {
        background-size: cover;
        font: 400 18px Arial;
    }

    .error {
        border: 2px solid red;
    }
    </style>
</head>

<body onfocusout="parent.setEmailRange();" style="overflow-wrap: break-word;">
    <div style="left: 15%; width: 600px; height: 580px; margin-top: 5%; position: fixed; padding:10px" id="tree-modal" class="form" onsubmit="setData(false)">
        <form action="#" onsubmit="setData(false)">
            <table class="row" style="border-collapse: collapse; margin-left: 0px; margin-bottom: 5px ">
                <tbody>
                    <tr>
                        <td>
                            <input class="cancel" type="button" value="Відміна" style="width:80px; height:50px; margin-left:0px; ">
                        </td>
                        <td>
                            <textarea style="border-radius:5px;" id="address" rows="2" cols="150" readonly=""></textarea>
                            <input type="text" class="inputs" id="search" oninput="Search()" placeholder="Підсвітити" autocomplete="off">
                        </td>
                        <td>
                            <input style="width:80px; height:50px; " onclick="setData(false)" value="Внести" type="button" class="submit" tabindex="4">
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="row" style="height: 500px; width:70%; overflow: auto; background-color: white; border-radius:5px;">
                <div id="jstree"></div>
                <div style="position:absolute; right:10px; top:13%; width:25%" id="buttons">
                    <input style="margin-top:5px; display:block;" type="button" value="Додати Елемент" class="Add Element" id="addCancelBtn" onclick="addElementBTN()" tabindex="1">
                    <div id="inputs" style="display: none;">
                        <label for="name">Назва
                            <img alt="Обязательное" src="/_imgs/imagestrips/transparent_spacer.gif" class="ms-crm-ImageStrip-frm_required">
                            <textarea type="text" id="name" style="width: 96%;" placeholder="Назва" class="" tabindex="2"></textarea>
                        </label>
                        <label for="oldName">Стара назва
                            <textarea type="text" id="oldName" style="width: 96%;" class="" placeholder="Стара назва"></textarea>
                        </label>
                        <label for="typeSelect">Тип
                            <img alt="Обязательное" src="/_imgs/imagestrips/transparent_spacer.gif" class="ms-crm-ImageStrip-frm_required"><br>
                            <select id="typeSelect" style="width: 100%;">
                            </select>
                        </label>
                        <input style="margin-top:5px; display:block;" type="button" value="Додати" id="AddBTN" onclick="Add(true)" tabindex="3">
                    </div>
                    <input style="margin-top:5px; display:block;" type="button" value="Перейменувати" class="Update Element" id="updateElementBTN" onclick="updateBTN()">
                    <div id="inputsUpdate" style="display: none;">
                        <label for="newName">Нова назва
                            <textarea type="text" id="newName" style="width: 96%;" placeholder="Нова назва" class=""></textarea>
                        </label>
                        <label for="SaveOldName" style="margin-left:15%;">
                            <input type="checkbox" id="SaveOldName" name="SaveOldName" style="position:absolute; right:40%;">Зберегти стару назву
                        </label>
                        <input style="margin-top:5px; display:block;" type="button" value="Підтвердити" id="UpdateBTN" onclick="Update()">
                    </div>

                    <input style="margin-top:5px; display:block;" type="button" value="Додати стару назву" id="addOldNameBTN" onclick="addOldNameBTNF()">
                    <div id="AddOldNameButtons" style="display: none;">
                        <label for="addOldName">Стара назва
                            <textarea type="text" id="addOldName" style="width: 96%;" placeholder="Стара назва" class=""></textarea>
                        </label>
                        <input style="margin-top:5px; display:block;" type="button" value="Підтвердити" id="addNameBTN" onclick="UpdateOldName()">
                    </div>
                    <input style="margin-top:5px; display:block;" type="button" value="Змінити тип" id="changeTypePanelBTN" onclick="сhangeTypeBTNF()">
                    <div id="сhangeTypePanel" style="display: none;">
                        <label for="typeSelectNew">Тип
                            <img alt="Обязательное" src="/_imgs/imagestrips/transparent_spacer.gif" class="ms-crm-ImageStrip-frm_required"><br>
                            <select id="typeSelectNew" style="width: 100%;"></select>
                        </label>
                        <input style="margin-top:5px; display:block;" type="button" value="Підтвердити" id="changeType" onclick="changeTypeFunk()">
                    </div>

                    <input style="margin-top:15px; display:block;" type="button" value="Оновити" id="refreshBTN" onclick="refresh_node()">
                    <div id="adminPanel" style="display:none;">
                        <input class="submit" id="delete" style="margin-top:20px; display:block;" type="button" value="Видалити" onclick="Delete()">
                        <input id="test" style="margin-top:5px; display:block;" type="button" value="Test" onclick="Test()"> <!-- onclick="Add(false)  findDuplicate()  setData(true) Test()"> -->
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script type="text/javascript">
    $(function() {
        if (parent.frames[0].Xrm.Page.getAttribute("name").getValue() != null) {
            document.getElementById('address').value = parent.frames[0].Xrm.Page.getAttribute("name").getValue();
        } else {
            document.getElementById('address').value = getAddressIds('address');
        };
        hideAdminPanel();

        $('#jstree').jstree({
            'core': {
                'data': {
                    'url': function(node) {
                        return '/settlementData.aspx';
                    },
                    'data': function(node) {
                        return { 'id': node.id };
                    }
                }
            },
            "plugins": ["search"],
            "search": {
                "case_sensitive": false,
                "show_only_matches": false
            }
        }).on("ready.jstree", function(event, data) {
            var ids = getAddressIds('ids');
            $(this).jstree("open_node", "3d858ee8-0fd8-e511-81c4-00155d0f090d");
            $.each(ids, function(key, value) {
                var y = value.replace('{', '').replace('}', '').toLowerCase();
                $('#jstree').on('after_open.jstree', function(event, data) {
                    if ($("#jstree").jstree("get_selected", true).length == 0) {
                        $(this).jstree("open_node", y);
                        if ($('#' + y)[0] != undefined) {
                            if (y == ids[ids.length - 1].replace('{', '').replace('}', '').toLowerCase()) {
                                $('#jstree').jstree("select_node", y, true).bind("select_node.jstree", function() {
                                    setTypes();
                                    setNameToUpdate();
                                });
                            };
                            var other = "#jstree #" + y;
                            $(other)[0].scrollIntoView();
                        };
                    };
                });
            });
        });
    });

    function Test() {
        console.log("test");
        $("#jstree").jstree("deselect_all", true);
    };


    function hideAdminPanel() {
        var role = Xrm.Page.context.getUserRoles();
        var delRoles = ["55d2f43e-ad08-e311-8620-00155d001525", "3319aaff-a901-e811-80cf-00155d0f313b"];
        var hide = false;
        $.each(role, function(key, value) {
            $.each(delRoles, function(key1, value1) {
                if (value == value1) hide = true;
            });
        });
        if (hide) {
            document.getElementById('adminPanel').style.display = 'block';
            //document.getElementById('changeTypePanelBTN').style.display = 'block';
        };
    };

    function refresh_node() {
        var t = $("#jstree").jstree("get_selected", true);
        $('#jstree').jstree(true).refresh_node(t[0].id);
        $('#jstree').jstree("open_node", t[0].id);
    };

    function refreshParentNode() {
        setTimeout(function() {
            var t = $("#jstree").jstree("get_selected", true);
            var parentId = $("#jstree").jstree("get_parent", t[0].id);
            $('#jstree').jstree(true).refresh_node(parentId);
        }, 1000);
    };

    function removeOptions(selectbox) {
        var i;
        for (i = selectbox.options.length - 1; i >= 0; i--) {
            selectbox.remove(i);
        };
    };

    function Search() {
        var search = document.getElementById("search").value;
        $("#jstree").jstree("search", search);
    };

    function getChilds(typeName) {
        var childDict = new Object();
        var childDict = {
            "#": { "93e1908a-3e14-e611-80d9-00155d0f0906": "Країна" },
            "rgc_country": { "b0e0889b-3e14-e611-80d9-00155d0f0906": "Область" }, //область рай знач
            "rgc_state": { //район нас/пункт
                "c804caa6-3e14-e611-80d9-00155d0f0906": "Район Обл. значения",
                "e60c1e03-3f14-e611-80d9-00155d0f0906": "СМТ",
                "9c55500c-3f14-e611-80d9-00155d0f0906": "Село",

                "07912DDA-A526-E811-80D5-00155D0F313B": "Місто", //
                "42742082-885D-E811-8122-02BF0A300F39": "Військове містечко", //
                "85340D3B-930A-E811-80CF-00155D0F313B": "Міська рада", //
                "57C4F8F7-D28F-E811-80DF-00155D0F0D4E": "Селищна рада", //
                "2844C7E2-930A-E811-80CF-00155D0F313B": "Сільська рада", //
                "DCDB7E3D-DCE8-E811-8135-00155D0F0938": "Кооператив", //
                "DD7DE62B-CB2D-E811-811E-02BF0A300F39": "Коттеджне поселення", //
                "A84C0C12-0DDD-E811-8134-02BF0A300F39": "Селище" //
            },
            "rgc_county": {
                "4b0454d5-3e14-e611-80d9-00155d0f0906": "Місто",
                "e60c1e03-3f14-e611-80d9-00155d0f0906": "СМТ",
                "9c55500c-3f14-e611-80d9-00155d0f0906": "Село",
                "0F176B82-DA0F-E811-8119-02BF0A300F39": "Садовое товариство", //
                "DCDB7E3D-DCE8-E811-8135-00155D0F0938": "Кооператив", //
                "DD7DE62B-CB2D-E811-811E-02BF0A300F39": "Коттеджне поселення", //
                "A84C0C12-0DDD-E811-8134-02BF0A300F39": "Селище" //
                //селище
            },
            "rgc_locality": {
                "8E2896f2-3e14-e611-80d9-00155d0f0906": "Вулиця",
                "a80ced51-3f14-e611-80d9-00155d0f0906": "Провулок",
                "9bbf6f22-3f14-e611-80d9-00155d0f0906": "Площа",
                "ef418e49-3f14-e611-80d9-00155d0f0906": "Проспект",
                "5769492d-3f14-e611-80d9-00155d0f0906": "Бульвар",
                "456A74AA-805E-E811-8123-00155D0F0938": "Сквер", //
                "7E54CDFB-A526-E811-80D5-00155D0F313B": "Район міського значення", //
                "68533C37-2C79-E811-80DE-00155D0F0D4E": "Мікрорайон", //
                "1D46F454-F8FC-E611-80EB-00155D0F0938": "В'їзд", //
                "77064A73-9DFD-E611-80EB-00155D0F0938": "Аллея", //
                "FF4323B3-7655-E611-80E5-00155D0F0939": "Жилий масив", //
                "AFD01FB6-D964-E811-8124-00155D0F0938": "Заїзд", //
                "811E19DC-568E-E711-8108-02BF0A300F39": "Кілометр", //
                "1139DD7D-AA54-E611-80E5-00155D0F0939": "Парк", //
                "B2BEFF81-3C18-E711-80EF-00155D0F0938": "Переїзд", //
                "A80CED51-3F14-E611-80D9-00155D0F0906": "Провулок", //
                "456A74AA-805E-E811-8123-00155D0F0938": "Сквер", //
                "3367B078-5E5E-E811-8123-00155D0F0938": "Урочище", //
                "C4450C0D-4865-E611-80E6-00155D0F0939": "Квартал", // 
                "D00364A0-5029-E911-8144-00155D0F0938": "Совхоз", //
                "0F176B82-DA0F-E811-8119-02BF0A300F39": "Садовое товариство", //
                "c72ccfc8-0ef8-e611-80eb-00155d0f0938": "Проріз",
                "fab5c76e-3f14-e611-80d9-00155d0f0906": "Проїзд",
                "a7157858-4364-e611-80e6-00155d0f0939": "Шоссе",
                "02c71d60-0b69-e611-80e6-00155d0f0939": "Узвіз",
                "e15e1577-cf3b-e711-8100-00155d0f0939": "Тупик"
            },
            "rgc_localcounty": {
                "8E2896f2-3e14-e611-80d9-00155d0f0906": "Вулиця",
                "a80ced51-3f14-e611-80d9-00155d0f0906": "Провулок",
                "9bbf6f22-3f14-e611-80d9-00155d0f0906": "Площа",
                "ef418e49-3f14-e611-80d9-00155d0f0906": "Проспект",
                "5769492d-3f14-e611-80d9-00155d0f0906": "Бульвар",
                "456A74AA-805E-E811-8123-00155D0F0938": "Сквер", //
                "1D46F454-F8FC-E611-80EB-00155D0F0938": "В'їзд", //
                "77064A73-9DFD-E611-80EB-00155D0F0938": "Аллея", //
                "FF4323B3-7655-E611-80E5-00155D0F0939": "Жилий масив", //
                "AFD01FB6-D964-E811-8124-00155D0F0938": "Заїзд", //
                "811E19DC-568E-E711-8108-02BF0A300F39": "Кілометр", //
                "1139DD7D-AA54-E611-80E5-00155D0F0939": "Парк", //
                "B2BEFF81-3C18-E711-80EF-00155D0F0938": "Переїзд", //
                "A80CED51-3F14-E611-80D9-00155D0F0906": "Провулок", //
                "456A74AA-805E-E811-8123-00155D0F0938": "Сквер", //
                "3367B078-5E5E-E811-8123-00155D0F0938": "Урочище", //
                "C4450C0D-4865-E611-80E6-00155D0F0939": "Квартал", // 
                "D00364A0-5029-E911-8144-00155D0F0938": "Совхоз", //
                "0F176B82-DA0F-E811-8119-02BF0A300F39": "Садовое товариство", //
                "c72ccfc8-0ef8-e611-80eb-00155d0f0938": "Проріз",
                "fab5c76e-3f14-e611-80d9-00155d0f0906": "Проїзд",
                "a7157858-4364-e611-80e6-00155d0f0939": "Шоссе",
                "02c71d60-0b69-e611-80e6-00155d0f0939": "Узвіз",
                "e15e1577-cf3b-e711-8100-00155d0f0939": "Тупик"
            },
            "rgc_street": {
                "12054e81-3f14-e611-80d9-00155d0f0906": "Будинок"
            }
        };
        return childDict[typeName];
    };

    function getTypeField2(id) {
        if (id == "all") {

        } else {
            var typeDict = {
                "rgc_country": ["93e1908a-3e14-e611-80d9-00155d0f0906"], //страна
                "rgc_state": ["b0e0889b-3e14-e611-80d9-00155d0f0906"],
                "rgc_county": ["c804caa6-3e14-e611-80d9-00155d0f0906",
                    "85340d3b-930a-e811-80cf-00155d0f313b"
                ],
                "rgc_locality": ["4b0454d5-3e14-e611-80d9-00155d0f0906", //населенный пункт
                    "e60c1e03-3f14-e611-80d9-00155d0f0906",
                    "07912dda-a526-e811-80d5-00155d0f313b",
                    "9c55500c-3f14-e611-80d9-00155d0f0906",
                    "0f176b82-da0f-e811-8119-02bf0a300f39", //
                    "dcdb7e3d-dce8-e811-8135-00155d0f0938", //
                    "dd7de62b-cb2d-e811-811e-02bf0a300f39", //
                    "a84c0c12-0ddd-e811-8134-02bf0a300f39", //
                    "57c4f8f7-d28f-e811-80df-00155d0f0d4e", //
                    "2844c7e2-930A-e811-80cf-00155d0f313b"
                ],
                "rgc_localcounty": [
                    "0f176b82-da0f-e811-8119-02bf0a300f39", //район города
                    "d00364a0-5029-e911-8144-00155d0f0938",
                    "7e54cdfb-a526-e811-80d5-00155d0f313b",
                    "42742082-885d-e811-8122-02bf0a300f39",
                    "ff4323b3-7655-e611-80e5-00155d0f0939",
                    "c4450c0d-4865-e611-80e6-00155d0f0939",
                    "dcdb7e3d-dce8-e811-8135-00155d0f0938",
                    "dd7de62b-cb2d-e811-811e-02bf0a300f39",
                    "57c4f8f7-d28f-e811-80df-00155d0f0d4e",
                    "2844c7e2-930A-e811-80cf-00155d0f313b",

                    "68533c37-2c79-e811-80de-00155d0f0d4e"
                ],
                "rgc_street": [
                    "8e2896f2-3e14-e611-80d9-00155d0f0906",
                    "9bbf6f22-3f14-e611-80d9-00155d0f0906",
                    "a80ced51-3f14-e611-80d9-00155d0f0906",
                    "6084063c-3f14-e611-80d9-00155d0f0906",
                    "02c71d60-0b69-e611-80e6-00155d0f0939",
                    "a7157858-4364-e611-80e6-00155d0f0939",

                    "ef418e49-3f14-e611-80d9-00155d0f0906", //улица
                    "456a74aa-805e-e811-8123-00155d0f0938", //
                    "1d46f454-f8fc-e611-80eb-00155d0f0938", //
                    "77064a73-9dfd-e611-80eb-00155d0f0938", //
                    "ff4323b3-7655-e611-80e5-00155d0f0939", //
                    "afd01fb6-d964-e811-8124-00155d0f0938", //
                    "811e19dc-568e-e711-8108-02bf0a300f39", //
                    "1139dd7d-aa54-e611-80e5-00155d0f0939", //
                    "b2beff81-3c18-e711-80ef-00155d0f0938", //
                    "3367b078-5e5e-e811-8123-00155d0f0938", //
                    "c4450c0d-4865-e611-80e6-00155d0f0939", // 
                    "d00364a0-5029-e911-8144-00155d0f0938", //
                    "0f176b82-da0f-e811-8119-02bf0a300f39", //
                    "e15e1577-cf3b-e711-8100-00155d0f0939", //
                    "fAb5c76e-3f14-e611-80d9-00155d0f0906", //
                    "c72ccfc8-0ef8-e611-80eb-00155d0f0938", //
                    "5769492d-3f14-e611-80d9-00155d0f0906",
                    "fab5c76e-3f14-e611-80d9-00155d0f0906"
                ], //

                "rgc_house": ["12054e81-3f14-e611-80d9-00155d0f0906"], //дом
                "line3": [
                    "89628a89-3f14-e611-80d9-00155d0f0906",
                    "8d92aae3-de4c-e611-80e5-00155d0f0939",
                    "498cdb4d-b452-e811-8120-02bf0A300f39",
                    "42188ff2-db8f-e811-80df-00155d0f0d4e",
                    "8c773dc5-935A-e811-8122-02bf0A300f39"
                ]
            };
            var a = [];
            $.each(typeDict, function(key, value) {
                for (var i = 0; i < typeDict[key].length; i++) {
                    if (typeDict[key][i] == id) {
                        a.push(key);
                    }
                };
            });
            return a;
        }
    };

    function addElementBTN() {
        if (document.getElementById('addCancelBtn').value == "Додати Елемент") {
            setTypes();
            document.getElementById("name").value = "";
            document.getElementById("oldName").value = "";
            document.getElementById("name").className = document.getElementById("name").className.replace(" error", "");
            document.getElementById("typeSelect").className = document.getElementById("typeSelect").className.replace(" error", "");
            document.getElementById('inputs').style.display = 'block';

            document.getElementById('inputsUpdate').style.display = "none";
            document.getElementById('updateElementBTN').value = "Перейменувати";

            document.getElementById('AddOldNameButtons').style.display = "none";
            document.getElementById('addOldNameBTN').value = "Додати стару назву";

            document.getElementById('сhangeTypePanel').style.display = "none";
            document.getElementById('changeTypePanelBTN').value = "Змінити тип";

            document.getElementById('addCancelBtn').value = 'Відмінити';
            document.getElementById("name").focus();
        } else if (document.getElementById('addCancelBtn').value == 'Відмінити') {
            document.getElementById("name").value = "";
            document.getElementById("oldName").value = "";
            document.getElementById('inputs').style.display = 'none';
            document.getElementById('addCancelBtn').value = "Додати Елемент";
        };
    };

    function updateBTN() {
        if (document.getElementById('updateElementBTN').value == "Перейменувати") {
            setNameToUpdate();
            document.getElementById('newName').className = document.getElementById("name").className.replace(" error", "");
            document.getElementById('inputsUpdate').style.display = "block";

            document.getElementById('inputs').style.display = 'none';
            document.getElementById('addCancelBtn').value = 'Додати Елемент';

            document.getElementById('AddOldNameButtons').style.display = "none";
            document.getElementById('addOldNameBTN').value = "Додати стару назву";

            document.getElementById('сhangeTypePanel').style.display = "none";
            document.getElementById('changeTypePanelBTN').value = "Змінити тип";

            document.getElementById('updateElementBTN').value = "Відмінити";
            document.getElementById('newName').focus();
        } else if (document.getElementById('updateElementBTN').value == "Відмінити") {
            document.getElementById('newName').value = "";
            document.getElementById('inputsUpdate').style.display = "none";
            document.getElementById('updateElementBTN').value = "Перейменувати";
        };
    };

    function addOldNameBTNF() {
        if (document.getElementById('addOldNameBTN').value == "Додати стару назву") {
            //setNameToUpdate();
            document.getElementById('inputsUpdate').style.display = "none";
            document.getElementById('updateElementBTN').value = "Перейменувати";

            document.getElementById('inputs').style.display = 'none';
            document.getElementById('addCancelBtn').value = 'Додати Елемент';

            document.getElementById('сhangeTypePanel').style.display = "none";
            document.getElementById('changeTypePanelBTN').value = "Змінити тип";

            document.getElementById('addOldName').className = document.getElementById("name").className.replace(" error", "");
            document.getElementById('AddOldNameButtons').style.display = "block";
            document.getElementById('addOldNameBTN').value = "Відмінити";
            document.getElementById('addOldName').focus();
        } else if (document.getElementById('addOldNameBTN').value == "Відмінити") {
            document.getElementById('addOldName').value = "";
            document.getElementById('AddOldNameButtons').style.display = "none";
            document.getElementById('addOldNameBTN').value = "Додати стару назву";
        };
    };

    function сhangeTypeBTNF() {
        if (document.getElementById('changeTypePanelBTN').value == "Змінити тип") {
            setAllTypes();
            document.getElementById('inputs').style.display = 'none';
            document.getElementById('addCancelBtn').value = 'Додати Елемент';

            document.getElementById('inputsUpdate').style.display = "none";
            document.getElementById('updateElementBTN').value = "Перейменувати";

            document.getElementById('AddOldNameButtons').style.display = "none";
            document.getElementById('addOldNameBTN').value = "Додати стару назву";

            //document.getElementById('addOldName').className = document.getElementById("name").className.replace(" error", "");
            document.getElementById('сhangeTypePanel').style.display = "block";
            document.getElementById('changeTypePanelBTN').value = "Відмінити";
            //document.getElementById('addOldName').focus();
        } else if (document.getElementById('changeTypePanelBTN').value == "Відмінити") {
            //document.getElementById('addOldName').value = "";
            document.getElementById('сhangeTypePanel').style.display = "none";
            document.getElementById('changeTypePanelBTN').value = "Змінити тип";
        };
    };


    function changeTypeFunk() {
    	var t = $("#jstree").jstree("get_selected", true);
    	var e = document.getElementById('typeSelectNew');    	
    	
        if (e.options[e.selectedIndex].value != undefined) {
        	console.log(e.options[e.selectedIndex].value);
            var typeName = e.options[e.selectedIndex].value;
        };
        var typeId = e.options[e.selectedIndex].id;

    	var confirmStr = "Упевнені що хочете змінити тип на "+ typeName;
    	if (confirm(confirmStr)) {
    		var entity = {};
			entity["rgc_type@odata.bind"] = "/rgk_settlement_types("+typeId+")";
			var req = new XMLHttpRequest();
			req.open("PATCH", Xrm.Page.context.getClientUrl() + "/api/data/v8.1/rgc_settlements("+t[0].id+")", true);
			req.setRequestHeader("OData-MaxVersion", "4.0");
			req.setRequestHeader("OData-Version", "4.0");
			req.setRequestHeader("Accept", "application/json");
			req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
			req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
			req.onreadystatechange = function() {
			    if (this.readyState === 4) {
			        req.onreadystatechange = null;
			        if (this.status === 204) {
			            //Success - No Return Data - Do Something
			        } else {
			            Xrm.Utility.alertDialog(this.statusText);
			        }
			    }
			};
			req.send(JSON.stringify(entity));
    		refreshParentNode();
    	}
    };

    function Update() {
        if (document.getElementById("newName").value == "") {
            alert("Помилка: Поле 'Нова назва' не може бути порожнім!");
            document.getElementById("newName").className = document.getElementById("name").className + " error";
        } else {
            var t = $("#jstree").jstree("get_selected", true);
            var x = $("#SaveOldName").is(":checked");
            var parent_value = "";
            var type_value = "";
            var rgc_name = "";
            var req = new XMLHttpRequest();
            req.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgc_settlements(" + t[0].id + ")?$select=rgc_name,_rgc_parent_value,_rgc_type_value", false);
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            req.onreadystatechange = function() {
                if (this.readyState === 4) {
                    req.onreadystatechange = null;
                    if (this.status === 200) {
                        var result = JSON.parse(this.response);
                        rgc_name = result["rgc_name"];
                        parent_value = result["_rgc_parent_value"];
                        type_value = result["_rgc_type_value"];
                    } else {
                        Xrm.Utility.alertDialog(this.statusText);
                    }
                }
            };
            req.send();
            var confirmStr = "Підтвердження оновлення\nКолишня Назва: " + rgc_name + "\nНова назва: " + document.getElementById('newName').value;
            if (x) {
                confirmStr = confirmStr + "\nСтара назва: " + rgc_name;
            };
            if (confirm(confirmStr)) { //typeName
                var t = $("#jstree").jstree("get_selected", true);
                var entity = {};
                entity.rgc_name = document.getElementById("newName").value;
                if (x) {
                    entity.rgc_old_name = rgc_name;
                };
                entity["rgc_parent@odata.bind"] = "/rgc_settlements(" + parent_value + ")";
                entity["rgc_type@odata.bind"] = "/rgk_settlement_types(" + type_value + ")";

                var req = new XMLHttpRequest();
                req.open("PATCH", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgc_settlements(" + t[0].id + ")", false);
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                req.onreadystatechange = function() {
                    if (this.readyState === 4) {
                        req.onreadystatechange = null;
                        if (this.status === 204) {
                            //Success - No Return Data - Do Something
                        } else {
                            Xrm.Utility.alertDialog(this.statusText);
                        }
                    }
                };
                req.send(JSON.stringify(entity));
                refreshParentNode();
            };
        };
    };

    function UpdateOldName() {
        if (document.getElementById("addOldName").value == "") {
            alert("Помилка: Поле 'Стара назва' не може бути порожнім!");
            document.getElementById("addOldName").className = document.getElementById("addOldName").className + " error";
        } else {
            var t = $("#jstree").jstree("get_selected", true);
            var parent_value = "";
            var type_value = "";
            var rgc_name = "";
            var req = new XMLHttpRequest();
            req.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgc_settlements(" + t[0].id + ")?$select=rgc_name,_rgc_parent_value,_rgc_type_value", false);
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            req.onreadystatechange = function() {
                if (this.readyState === 4) {
                    req.onreadystatechange = null;
                    if (this.status === 200) {
                        var result = JSON.parse(this.response);
                        rgc_name = result["rgc_name"];
                        parent_value = result["_rgc_parent_value"];
                        type_value = result["_rgc_type_value"];
                    } else {
                        Xrm.Utility.alertDialog(this.statusText);
                    }
                }
            };
            req.send();
            var confirmStr = "Підтвердження оновлення\nСтара Назва: " + document.getElementById('addOldName').value;
            if (confirm(confirmStr)) { //typeName
                var t = $("#jstree").jstree("get_selected", true);
                var entity = {};
                entity.rgc_old_name = document.getElementById("addOldName").value;
                entity["rgc_parent@odata.bind"] = "/rgc_settlements(" + parent_value + ")";
                entity["rgc_type@odata.bind"] = "/rgk_settlement_types(" + type_value + ")";

                var req = new XMLHttpRequest();
                req.open("PATCH", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgc_settlements(" + t[0].id + ")", false);
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                req.onreadystatechange = function() {
                    if (this.readyState === 4) {
                        req.onreadystatechange = null;
                        if (this.status === 204) {
                            //Success - No Return Data - Do Something
                        } else {
                            Xrm.Utility.alertDialog(this.statusText);
                        }
                    }
                };
                req.send(JSON.stringify(entity));
                refreshParentNode();
            };
        };
    };

    function findDuplicate() {
        var find = false;
        var nameFound = false;
        var parentNode = $("#jstree").jstree("get_selected");
        var currentNode = $("#jstree").jstree("get_selected", true);
        var createName = document.getElementById("name").value.toLowerCase();
        var childrens = $("#jstree").jstree("get_children_dom", parentNode);
        var rgc_name = "";
        for (var i = 0; i < childrens.length; i++) {
            var req = new XMLHttpRequest();
            req.open("GET", Xrm.Page.context.getClientUrl() + "/api/data/v8.1/rgc_settlements(" + childrens[i].id + ")?$select=rgc_name", false);
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            req.onreadystatechange = function() {
                if (this.readyState === 4) {
                    req.onreadystatechange = null;
                    if (this.status === 200) {
                        var result = JSON.parse(this.response);
                        rgc_name = result["rgc_name"];
                    } else {
                        Xrm.Utility.alertDialog(this.statusText);
                    }
                }
            };
            req.send();
            var childName = rgc_name.toLowerCase();
            var childId = childrens[i].id;
            if (createName == childName) {
                var req = new XMLHttpRequest();
                req.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgc_settlements?$select=_rgc_type_value&$filter=rgc_name%20eq%20'" + childName + "' and  _rgc_parent_value eq " + currentNode[0].id, false);
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                req.onreadystatechange = function() {
                    if (this.readyState === 4) {
                        req.onreadystatechange = null;
                        if (this.status === 200) {
                            var results = JSON.parse(this.response);
                            for (var i = 0; i < results.value.length; i++) {
                                var _rgc_type_value = results.value[i]["_rgc_type_value"];

                                var e = document.getElementById('typeSelect');
                                var typeId = e.options[e.selectedIndex].id;

                                if (_rgc_type_value.toLowerCase() == typeId.toLowerCase()) {
                                    find = true;
                                    break;
                                }
                            }
                        } else {
                            Xrm.Utility.alertDialog(this.statusText);
                        }
                    }
                };
                req.send();
                if (find) break;
            };
        };
        return find;
    };

    function setNameToUpdate() {
        var t = $("#jstree").jstree("get_selected", true);
        var name = "";
        var req = new XMLHttpRequest();
        req.open("GET", Xrm.Page.context.getClientUrl() + "/api/data/v8.1/rgc_settlements(" + t[0].id + ")?$select=rgc_name", false);
        req.setRequestHeader("OData-MaxVersion", "4.0");
        req.setRequestHeader("OData-Version", "4.0");
        req.setRequestHeader("Accept", "application/json");
        req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
        req.onreadystatechange = function() {
            if (this.readyState === 4) {
                req.onreadystatechange = null;
                if (this.status === 200) {
                    var result = JSON.parse(this.response);
                    name = result["rgc_name"];
                } else {
                    Xrm.Utility.alertDialog(this.statusText);
                }
            }
        };
        req.send();
        document.getElementById("newName").value = name;
    };

    function setTypes() {
        removeOptions(document.getElementById("typeSelect"));
        var t = $("#jstree").jstree("get_selected", true);
        var ttt = t[0].id;
        var req = new XMLHttpRequest();
        rqstr = "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgc_settlements?$select=rgc_name,_rgc_type_value&$filter=rgc_settlementid%20eq%20" + ttt;
        req.open("GET", rqstr, true);
        req.setRequestHeader("OData-MaxVersion", "4.0");
        req.setRequestHeader("OData-Version", "4.0");
        req.setRequestHeader("Accept", "application/json");
        req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        req.onreadystatechange = function() {
            if (this.readyState === 4) {
                req.onreadystatechange = null;
                if (this.status === 200) {
                    var results = JSON.parse(this.response);
                    for (var i = 0; i < results.value.length; i++) {
                        var _rgc_type_value = results.value[i]["_rgc_type_value"];
                        var _rgc_settlementid = results.value[i]["rgc_settlementid"];
                        var _rgc_name = results.value[i]["rgc_name"];
                        var arrTypes = getTypeField2(_rgc_type_value);
                        var x = document.getElementById("typeSelect");
                        var option = document.createElement("option");
                        for (var i = 0; i < arrTypes.length; i++) {
                            var j = getChilds(arrTypes[i]);
                            if (j != undefined) {
                                $.each(j, function(key, value) {
                                    var option = document.createElement("option");
                                    option.text = value;
                                    option.id = key;
                                    x.add(option);
                                });
                            };
                        };
                    };
                } else {
                    Xrm.Utility.alertDialog(this.statusText);
                };
            };
        };
        req.send();
    };
    
    function setAllTypes(){
		removeOptions(document.getElementById("typeSelectNew"));
        //var t = $("#jstree").jstree("get_selected", true);
        var req = new XMLHttpRequest();
        rqstr = "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgk_settlement_types()?$select=rgk_name,rgk_settlement_typeid";
        req.open("GET", rqstr, true);
        req.setRequestHeader("OData-MaxVersion", "4.0");
        req.setRequestHeader("OData-Version", "4.0");
        req.setRequestHeader("Accept", "application/json");
        req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        req.onreadystatechange = function() {
            if (this.readyState === 4) {
                req.onreadystatechange = null;
                if (this.status === 200) {
                    var results = JSON.parse(this.response);
                    console.log(results);
                    var x = document.getElementById("typeSelectNew");
                    for (var i = 0; i < results.value.length; i++) {                     
                        var option = document.createElement("option");
                        option.text = results.value[i]["rgk_name"];
                        option.id = results.value[i]["rgk_settlement_typeid"];
                    	x.add(option); 
                    };
                } else {
                    Xrm.Utility.alertDialog(this.statusText);
                };
            };
        };
        req.send();
    };

    function Add(arg) {
        var e = document.getElementById('typeSelect');
        if (e.options[e.selectedIndex].value != undefined) {
            var typeName = e.options[e.selectedIndex].value;
        };
        var typeId = e.options[e.selectedIndex].id;

        if (document.getElementById("name").value == "") {
            alert("Eror: The Name field can`t be empty! \nОшибка: Поле Имя не может быть пустым!");
            document.getElementById("name").className = document.getElementById("name").className + " error";
        } else {
            if (confirm("Підтвердження додавання\nНазва: " + document.getElementById("name").value + "\nСтара назва: " + document.getElementById('oldName').value + "\nТип розташування:" + typeName)) {

                var find = findDuplicate();
                setTimeout(function() { var find = findDuplicate() }, 2000);
                console.log(find);

                if (!find) {
                    document.getElementById("name").className = document.getElementById("name").className.replace(" error", "");
                    document.getElementById("typeSelect").className = document.getElementById("typeSelect").className.replace(" error", "");

                    var currentNode = $("#jstree").jstree("get_selected", true);
                    var entity = {};
                    entity.rgc_name = document.getElementById("name").value;

                    if (document.getElementById('oldName').value != "") entity.rgc_old_name = document.getElementById('oldName').value;
                    entity["rgc_parent@odata.bind"] = "/rgc_settlements(" + currentNode[0].id + ")";
                    entity["rgc_type@odata.bind"] = "/rgk_settlement_types(" + typeId + ")";

                    var req = new XMLHttpRequest();
                    req.open("POST", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgc_settlements", false);
                    req.setRequestHeader("OData-MaxVersion", "4.0");
                    req.setRequestHeader("OData-Version", "4.0");
                    req.setRequestHeader("Accept", "application/json");
                    req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                    req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    req.onreadystatechange = function() {
                        if (this.readyState === 4) {
                            req.onreadystatechange = null;
                            if (this.status === 204) {
                                var uri = this.getResponseHeader("OData-EntityId");
                                var regExp = /\(([^)]+)\)/;
                                var matches = regExp.exec(uri);
                                var newEntityId = matches[1];
                            } else {
                                Xrm.Utility.alertDialog(this.statusText);
                            }
                        }
                    };
                    req.send(JSON.stringify(entity));
                    refresh_node();
                    document.getElementById("name").value = "";
                    document.getElementById("oldName").value = "";
                    document.getElementById('inputs').style.display = 'none';
                    document.getElementById('addCancelBtn').value = 'Додати Елемент';
                    document.getElementById("jstree").focus();
                } else {
                    alert("Попытка создания дубликата!\nИзмените имя или тип");
                    document.getElementById("name").className = document.getElementById("name").className + " error";
                    document.getElementById("typeSelect").className = document.getElementById("typeSelect").className + " error";
                    document.getElementById("name").focus();
                }
            };
        };
    };

    function Delete() {
        var t = $("#jstree").jstree("get_selected", true);
        if (confirm(" Подтвердите удаление : " + t[0].text + " ?")) {
            var req = new XMLHttpRequest();
            req.open("DELETE", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgc_settlements(" + t[0].id + ")", true);
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");
            req.onreadystatechange = function() {
                if (this.readyState === 4) {
                    req.onreadystatechange = null;
                    if (this.status === 204 || this.status === 1223) {
                        //Success - No Return Data - Do Something
                    } else {
                        Xrm.Utility.alertDialog(this.statusText);
                    };
                };
            };
            req.send();
            /*$("#jstree").jstree("deselect_all",false);
            var yt = $("#jstree").jstree("get_selected", true);
            $('#jstree').jstree("select_node", yt, true)*/
            refreshParentNode();
        };
    };


    function getAddressIds(getTypeField) {
        var address = "";
        var ids = [];
        //console.log(ids)
        var rgc_country = parent.frames[0].Xrm.Page.getAttribute("rgc_country").getValue();
        var rgc_state = parent.frames[0].Xrm.Page.getAttribute("rgc_state").getValue();
        var rgc_county = parent.frames[0].Xrm.Page.getAttribute("rgc_county").getValue();
        var rgc_locality = parent.frames[0].Xrm.Page.getAttribute("rgc_locality").getValue();
        var rgc_localcounty = parent.frames[0].Xrm.Page.getAttribute("rgc_localcounty").getValue();
        var rgc_street = parent.frames[0].Xrm.Page.getAttribute("rgc_street").getValue();
        var rgc_house = parent.frames[0].Xrm.Page.getAttribute("rgc_house").getValue();
        if (getTypeField == "address") {
            var line3 = parent.frames[0].Xrm.Page.getAttribute("rgc_house").getValue();
            var rgc_apartmenttype = parent.frames[0].Xrm.Page.getAttribute("rgc_apartmenttype").getValue();
        }
        if (rgc_country != null) {
            address += rgc_country[0].name;
            ids.push(rgc_country[0].id);
        };
        if (rgc_state != null) {
            address += " " + rgc_state[0].name;
            ids.push(rgc_state[0].id);
        };
        if (rgc_county != null) {
            address += " " + rgc_county[0].name;
            ids.push(rgc_county[0].id);
        };
        if (rgc_locality != null) {
            address += " " + rgc_locality[0].name;
            ids.push(rgc_locality[0].id);
        };
        if (rgc_localcounty != null) {
            address += " " + rgc_localcounty[0].name;
            ids.push(rgc_localcounty[0].id);
        };
        if (rgc_street != null) {
            address += " " + rgc_street[0].name;
            ids.push(rgc_street[0].id);
        };
        if (rgc_house != null) {
            address += " " + rgc_house[0].name;
            ids.push(rgc_house[0].id);
        };

        if (getTypeField == "address") {
            if (line3 != null) {
                address += " " + rgc_apartmenttype + " " + line3;
            };
        };

        if (getTypeField == "address") {
            //console.log(address);
            return address;
        } else if (getTypeField == "ids") {
            //console.log(ids);
            return ids;
        } else return null;
    };

    function setData(arg) {
        var t = $("#jstree").jstree("get_selected", true);
        var tt = t[0].parents;
        var ttt = t[0].id;
        //console.log(t);
        var line3 = t[0].text;
        //console.log(tt);
        //console.log(ttt);

        if (t[0].id != tt[0]) {
            tt.unshift(t[0].id);
        };

        parent.frames[0].Xrm.Page.getAttribute("rgc_state").setValue(null);
        parent.frames[0].Xrm.Page.getAttribute("rgc_county").setValue(null);
        parent.frames[0].Xrm.Page.getAttribute("rgc_street").setValue(null);
        parent.frames[0].Xrm.Page.getAttribute("rgc_localcounty").setValue(null);
        parent.frames[0].Xrm.Page.getAttribute("rgc_locality").setValue(null);
        parent.frames[0].Xrm.Page.getAttribute("rgc_house").setValue(null);
        parent.frames[0].Xrm.Page.getAttribute("line3").setValue(null);

        for (var i = tt.length - 1; i >= 0; i--) {
            //console.log(tt[i]);
            var ttid = tt[i];
            //console.log(ttid);
            if (tt[i] != "#") {
                var req = new XMLHttpRequest();
                req.open("GET", "https://cc.ent.ukrgas.com.ua/gas/api/data/v8.1/rgc_settlements(" + ttid + ")?$select=rgc_name,_rgc_type_value", false);
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                req.onreadystatechange = function() {
                    if (this.readyState === 4) {
                        req.onreadystatechange = null;
                        if (this.status === 200) {
                            var result = JSON.parse(this.response);
                            var _rgc_name = result["rgc_name"];
                            var _rgc_type_value = result["_rgc_type_value"];
                            var _rgc_settlementid = ttid;

                            console.log("Type: " + _rgc_type_value + " SetId: " + _rgc_settlementid + " Name: " + _rgc_name);

                            var lookup = new Array();
                            lookup[0] = new Object();
                            lookup[0].entityType = "rgc_settlement";
                            lookup[0].id = _rgc_settlementid;
                            lookup[0].name = _rgc_name;
                            lookup[0].type = "10138";
                            lookup[0].typename = "rgc_settlement";


                            var arr = getTypeField2(_rgc_type_value);
                            if (arr.length != 0 && arr.length < 2) {
                                var get_typeFromId = arr[0];
                            } else if (arr.length != 0) {
                                var get_typeFromId = "";
                                //console.log(arr);
                                for (var i = 0; i < arr.length; i++) {
                                    if (get_typeFromId == "") {
                                        if (parent.frames[0].Xrm.Page.getAttribute(arr[i]).getValue() == null) {
                                            var get_typeFromId = arr[i];
                                            //console.log(get_typeFromId);
                                        }
                                    }
                                }
                            } else {
                                alert("Неизвестный тип расположения.\nСообщите о данной проблеме программисту.");
                            }
                            //var get_typeFromId = getTypeField(_rgc_type_value);
                            //console.log(lookup);
                            if (get_typeFromId == "line3") {
                                parent.frames[0].Xrm.Page.getAttribute(get_typeFromId).setValue(line3);
                            } else {
                                parent.frames[0].Xrm.Page.getAttribute(get_typeFromId).setValue(lookup);
                            };
                        } else {
                            Xrm.Utility.alertDialog(this.statusText);
                        }
                    }
                };
                req.send();
            };
        };
        if (!arg) Application._hideСontainer();

        setTimeout(function() {
            parent.frames[0].Xrm.Page.getAttribute("name").setValue(null);
            parent.frames[0].Xrm.Page.getControl("line3").setFocus();
        }, 750);
    };
    </script>
</body>

</html>